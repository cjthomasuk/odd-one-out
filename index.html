<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlie & Isla - Odd One Out</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const firebaseConfig = {
          apiKey: "AIzaSyCIz8Nja1unTQteI8eV62sSBW1dW49Ezhg",
          authDomain: "odd-one-out-game-f39ab.firebaseapp.com",
          databaseURL: "https://odd-one-out-game-f39ab-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "odd-one-out-game-f39ab",
          storageBucket: "odd-one-out-game-f39ab.firebasestorage.app",
          messagingSenderId: "1011236518991",
          appId: "1:1011236518991:web:10e0936a8069bcb57ebe3a",
          measurementId: "G-66NJNJJ52D"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const storage = {
            get: async (key, shared = false) => {
                if (shared) {
                    const snapshot = await database.ref(key).once('value');
                    if (snapshot.exists()) {
                        return { key, value: snapshot.val(), shared };
                    }
                    throw new Error('Key not found');
                } else {
                    const value = localStorage.getItem(key);
                    if (value === null) {
                        throw new Error('Key not found');
                    }
                    return { key, value, shared };
                }
            },
            set: async (key, value, shared = false) => {
                if (shared) {
                    await database.ref(key).set(value);
                    return { key, value, shared };
                } else {
                    localStorage.setItem(key, value);
                    return { key, value, shared };
                }
            },
            delete: async (key, shared = false) => {
                if (shared) {
                    await database.ref(key).remove();
                    return { key, deleted: true, shared };
                } else {
                    localStorage.removeItem(key);
                    return { key, deleted: true, shared };
                }
            }
        };

        const GAME_VERSION = '3.1.0';

        const emojiPairs = [
          ['üòÄ', 'üòÉ'], ['üòä', 'üòå'], ['üôÇ', 'üôÉ'], ['üòê', 'üòë'],
          ['ü§î', 'ü§®'], ['üò∂', 'üòê'], ['üåï', 'üåù'], ['üåë', '‚ö´'],
          ['‚¨õ', '‚óæ'], ['‚¨ú', '‚óΩ'], ['üîµ', 'üî∑'], ['üî¥', 'üî∫'],
          ['‚≠ê', 'üåü'], ['‚ú®', 'üí´'], ['üü¢', 'üü©'], ['üü°', 'üü®'],
          ['üî∂', 'üî∏'], ['üî∑', 'üîπ'], ['üòÑ', 'üòÅ'], ['üòè', 'üòí'],
          ['üò¥', 'üò™'], ['ü•±', 'üòÆ'], ['üòØ', 'üò≤'], ['üò≥', 'üò¶'],
          ['ü§ê', 'ü§´'], ['üò¨', 'üòÜ'], ['üåô', 'üåõ'], ['‚òÄÔ∏è', 'üåû'],
          ['‚≠ï', 'üî¥'], ['üü£', 'üü™'], ['üü§', 'üü´'], ['‚ö™', '‚ö´'],
          ['üíõ', 'üíö'], ['üíô', 'üíú'], ['üß°', '‚ù§Ô∏è'], ['üíó', 'üíñ'],
          ['üî≥', '‚¨ú'], ['üî≤', '‚¨õ'], ['‚ñ™Ô∏è', '‚óæ'], ['‚ñ´Ô∏è', '‚óΩ'],
          ['‚óºÔ∏è', '‚¨õ'], ['‚óªÔ∏è', '‚¨ú'], ['üü•', 'üî¥'], ['üü¶', 'üîµ'],
          ['üüß', 'üü†'], ['‚ö°', 'üí•'], ['üåà', 'üåÖ'], ['üîÜ', 'üîÖ']
        ];

        const ClockIcon = () => (
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" strokeWidth="2"/>
            <path d="M12 6v6l4 2" strokeWidth="2" strokeLinecap="round"/>
          </svg>
        );

        const TrophyIcon = () => (
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M6 9v12M18 9v12M6 21h12M8 3h8a2 2 0 0 1 2 2v4H6V5a2 2 0 0 1 2-2z" strokeWidth="2"/>
          </svg>
        );

        const RotateCcwIcon = () => (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M1 4v6h6M23 20v-6h-6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        );

        const LogOutIcon = () => (
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        );

        const OddOneOutGame = () => {
          const [grid, setGrid] = useState([]);
          const [oddIndex, setOddIndex] = useState(-1);
          const [gameActive, setGameActive] = useState(false);
          const [gameReady, setGameReady] = useState(false);
          const [startTime, setStartTime] = useState(null);
          const [currentTime, setCurrentTime] = useState(0);
          const [leaderboard, setLeaderboard] = useState([]);
          const [lastScore, setLastScore] = useState(null);
          const [currentUser, setCurrentUser] = useState(null);
          const [showLogin, setShowLogin] = useState(true);
          const [loginName, setLoginName] = useState('');
          const [loginPassword, setLoginPassword] = useState('');
          const [isRegistering, setIsRegistering] = useState(false);
          const [isResetting, setIsResetting] = useState(false);
          const [newPassword, setNewPassword] = useState('');
          const [updateAvailable, setUpdateAvailable] = useState(false);

          useEffect(() => {
            checkVersion();
            loadLeaderboard();
            checkLoggedInUser();
            
            const leaderboardRef = database.ref('charlie-isla-leaderboard-v2');
            leaderboardRef.on('value', (snapshot) => {
              if (snapshot.exists()) {
                const data = JSON.parse(snapshot.val());
                setLeaderboard(data);
              }
            });
            
            const interval = setInterval(() => {
              checkVersion();
            }, 5000);
            
            return () => {
              clearInterval(interval);
              leaderboardRef.off();
            };
          }, []);

          useEffect(() => {
            let interval;
            if (gameActive && startTime) {
              interval = setInterval(() => {
                setCurrentTime(Date.now() - startTime);
              }, 10);
            }
            return () => clearInterval(interval);
          }, [gameActive, startTime]);

          const checkVersion = async () => {
            try {
              const result = await storage.get('charlie-isla-game-version', true);
              if (result) {
                const storedVersion = result.value;
                if (storedVersion !== GAME_VERSION) {
                  setUpdateAvailable(true);
                }
              } else {
                await storage.set('charlie-isla-game-version', GAME_VERSION, true);
              }
            } catch (error) {
              try {
                await storage.set('charlie-isla-game-version', GAME_VERSION, true);
              } catch (e) {
                console.log('Could not set version');
              }
            }
          };

          const checkLoggedInUser = async () => {
            try {
              const result = await storage.get('charlie-isla-current-user', false);
              if (result) {
                setCurrentUser(JSON.parse(result.value));
                setShowLogin(false);
              }
            } catch (error) {
              console.log('No user logged in');
            }
          };

          const handleLogin = async () => {
            if (!loginName.trim() || !loginPassword.trim()) {
              alert('Please enter both username and password');
              return;
            }

            try {
              const userKey = `charlie-isla-user-${loginName.trim().toLowerCase()}`;
              
              let result;
              try {
                result = await storage.get(userKey, true);
              } catch (e) {
                result = null;
              }

              if (isRegistering) {
                if (result) {
                  alert('Username already exists! Please choose a different name or login.');
                  return;
                }
                
                const newUser = { name: loginName.trim(), password: loginPassword };
                await storage.set(userKey, JSON.stringify(newUser), true);
                await storage.set('charlie-isla-current-user', JSON.stringify(newUser), false);
                
                setCurrentUser(newUser);
                setShowLogin(false);
                setLoginName('');
                setLoginPassword('');
              } else {
                if (!result) {
                  alert('User not found! Please register first.');
                  return;
                }

                const userData = JSON.parse(result.value);
                if (userData.password !== loginPassword) {
                  alert('Incorrect password!');
                  return;
                }

                await storage.set('charlie-isla-current-user', JSON.stringify(userData), false);
                setCurrentUser(userData);
                setShowLogin(false);
                setLoginName('');
                setLoginPassword('');
              }
            } catch (error) {
              console.error('Login error:', error);
              alert('Login failed: ' + error.message);
            }
          };

          const handleResetPassword = async () => {
            if (!loginName.trim() || !newPassword.trim()) {
              alert('Please enter both username and new password');
              return;
            }

            try {
              const userKey = `charlie-isla-user-${loginName.trim().toLowerCase()}`;
              const result = await storage.get(userKey, true);

              if (!result) {
                alert('User not found! Please check your username.');
                return;
              }

              const userData = JSON.parse(result.value);
              userData.password = newPassword;
              await storage.set(userKey, JSON.stringify(userData), true);
              
              alert('Password reset successfully! You can now login with your new password.');
              setIsResetting(false);
              setLoginName('');
              setNewPassword('');
            } catch (error) {
              console.error('Reset password error:', error);
              alert('Password reset failed. Please try again.');
            }
          };

          const handleLogout = async () => {
            try {
              await storage.delete('charlie-isla-current-user', false);
              setCurrentUser(null);
              setShowLogin(true);
              setGameReady(false);
              setGameActive(false);
            } catch (error) {
              console.error('Logout error:', error);
            }
          };

          const loadLeaderboard = async () => {
            try {
              const result = await storage.get('charlie-isla-leaderboard-v2', true);
              if (result) {
                const data = JSON.parse(result.value);
                setLeaderboard(data);
              } else {
                setLeaderboard([]);
              }
            } catch (error) {
              setLeaderboard([]);
            }
          };

          const saveLeaderboard = async (newLeaderboard) => {
            try {
              await storage.set('charlie-isla-leaderboard-v2', JSON.stringify(newLeaderboard), true);
            } catch (error) {
              console.error('Failed to save leaderboard:', error);
            }
          };

          const prepareGame = () => {
            const pair = emojiPairs[Math.floor(Math.random() * emojiPairs.length)];
            const [normal, odd] = Math.random() > 0.5 ? pair : [pair[1], pair[0]];
            
            const newGrid = Array(100).fill(normal);
            const randomOddIndex = Math.floor(Math.random() * 100);
            newGrid[randomOddIndex] = odd;
            
            setGrid(newGrid);
            setOddIndex(randomOddIndex);
            setGameReady(true);
            setGameActive(false);
            setCurrentTime(0);
            setLastScore(null);
          };

          const startGame = () => {
            const pair = emojiPairs[Math.floor(Math.random() * emojiPairs.length)];
            const [normal, odd] = Math.random() > 0.5 ? pair : [pair[1], pair[0]];
            
            const newGrid = Array(100).fill(normal);
            const randomOddIndex = Math.floor(Math.random() * 100);
            newGrid[randomOddIndex] = odd;
            
            setGrid(newGrid);
            setOddIndex(randomOddIndex);
            setGameActive(true);
            setStartTime(Date.now());
          };

          const handleClick = (index) => {
            if (!gameActive) return;
            
            if (index === oddIndex) {
              setGameActive(false);
              const finalTime = Date.now() - startTime;
              setCurrentTime(finalTime);
              setLastScore(finalTime);
              
              submitScoreAndContinue(finalTime);
            }
          };

          const submitScoreAndContinue = async (finalTime) => {
            if (!currentUser) return;
            
            const newEntry = {
              name: currentUser.name,
              time: finalTime,
              date: new Date().toISOString()
            };
            
            const playerTimes = {};
            [...leaderboard, newEntry].forEach(entry => {
              if (!playerTimes[entry.name] || entry.time < playerTimes[entry.name].time) {
                playerTimes[entry.name] = entry;
              }
            });
            
            const updatedLeaderboard = Object.values(playerTimes)
              .sort((a, b) => a.time - b.time);
            
            const position = updatedLeaderboard.findIndex(entry => entry.name === currentUser.name) + 1;
            
            const finalLeaderboard = updatedLeaderboard.slice(0, 10);
            
            setLeaderboard(finalLeaderboard);
            await saveLeaderboard(finalLeaderboard);
            
            if (position <= 10) {
              const positionEmoji = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : 'üèÜ';
              alert(`${positionEmoji} Great job! You're #${position} with ${formatTime(finalTime)}!`);
            } else {
              alert(`Good effort! Time: ${formatTime(finalTime)}. Keep trying!`);
            }
            
            prepareGame();
          };

          const formatTime = (ms) => {
            const seconds = Math.floor(ms / 1000);
            const milliseconds = Math.floor((ms % 1000) / 10);
            return `${seconds}.${milliseconds.toString().padStart(2, '0')}s`;
          };

          if (showLogin) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
                  <h1 className="text-4xl font-bold text-purple-600 mb-6 text-center">
                    üîç Charlie & Isla<br/>Odd One Out üîç
                  </h1>
                  <h2 className="text-2xl font-bold text-gray-700 mb-4 text-center">
                    {isResetting ? 'Reset Password' : isRegistering ? 'Register' : 'Login'}
                  </h2>
                  
                  {isResetting ? (
                    <div className="space-y-4">
                      <input
                        type="text"
                        value={loginName}
                        onChange={(e) => setLoginName(e.target.value)}
                        placeholder="Username"
                        className="w-full px-4 py-3 rounded-lg border-2 border-purple-300 focus:border-purple-500 outline-none text-lg"
                      />
                      <input
                        type="password"
                        value={newPassword}
                        onChange={(e) => setNewPassword(e.target.value)}
                        placeholder="New Password"
                        className="w-full px-4 py-3 rounded-lg border-2 border-purple-300 focus:border-purple-500 outline-none text-lg"
                        onKeyPress={(e) => e.key === 'Enter' && handleResetPassword()}
                      />
                      <button
                        onClick={handleResetPassword}
                        className="w-full bg-gradient-to-r from-orange-400 to-red-500 text-white text-xl font-bold py-3 rounded-lg hover:scale-105 transition-transform shadow-lg"
                      >
                        Reset Password
                      </button>
                      <button
                        onClick={() => {
                          setIsResetting(false);
                          setLoginName('');
                          setNewPassword('');
                        }}
                        className="w-full text-purple-600 font-semibold hover:underline"
                      >
                        Back to Login
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      <input
                        type="text"
                        value={loginName}
                        onChange={(e) => setLoginName(e.target.value)}
                        placeholder="Username"
                        className="w-full px-4 py-3 rounded-lg border-2 border-purple-300 focus:border-purple-500 outline-none text-lg"
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                        autoFocus
                      />
                      <input
                        type="password"
                        value={loginPassword}
                        onChange={(e) => setLoginPassword(e.target.value)}
                        placeholder="Password"
                        className="w-full px-4 py-3 rounded-lg border-2 border-purple-300 focus:border-purple-500 outline-none text-lg"
                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      />
                      <button
                        onClick={handleLogin}
                        className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white text-xl font-bold py-3 rounded-lg hover:scale-105 transition-transform shadow-lg"
                      >
                        {isRegistering ? 'Register & Start Playing' : 'Login'}
                      </button>
                      <button
                        onClick={() => setIsRegistering(!isRegistering)}
                        className="w-full text-purple-600 font-semibold hover:underline"
                      >
                        {isRegistering ? 'Already have an account? Login' : 'Need an account? Register'}
                      </button>
                      {!isRegistering && (
                        <button
                          onClick={() => {
                            setIsResetting(true);
                            setLoginName('');
                            setLoginPassword('');
                          }}
                          className="w-full text-gray-500 text-sm hover:underline"
                        >
                          Forgot password? Reset here
                        </button>
                      )}
                    </div>
                  )}
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">
              {updateAvailable && (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-yellow-400 text-black px-6 py-3 rounded-full shadow-2xl font-bold animate-bounce">
                  üîÑ New version available! Please refresh the page (F5) to update
                </div>
              )}
              
              {!gameReady && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
                    <h2 className="text-4xl font-bold text-purple-600 mb-4 text-center">
                      Welcome, {currentUser?.name}! üëã
                    </h2>
                    <p className="text-xl text-gray-700 mb-6 text-center">
                      Find the different emoji as fast as you can!
                    </p>
                    <button
                      onClick={prepareGame}
                      className="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white text-2xl font-bold py-4 rounded-lg hover:scale-105 transition-transform shadow-lg mb-3"
                    >
                      Start New Game üéÆ
                    </button>
                    <button
                      onClick={handleLogout}
                      className="w-full bg-gray-500 text-white text-lg font-semibold py-3 rounded-lg hover:bg-gray-600 transition-colors"
                    >
                      Login as Different User
                    </button>
                  </div>
                </div>
              )}

              {gameReady && !gameActive && (
                <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
                    <h2 className="text-3xl font-bold text-green-600 mb-4 text-center">
                      Ready to go! üöÄ
                    </h2>
                    <p className="text-lg text-gray-700 mb-6 text-center">
                      Click the button to reveal the emojis and start the timer!
                    </p>
                    <button
                      onClick={startGame}
                      className="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white text-2xl font-bold py-4 rounded-lg hover:scale-105 transition-transform shadow-lg"
                    >
                      Start Timer ‚è±Ô∏è
                    </button>
                  </div>
                </div>
              )}

              <div className="max-w-6xl mx-auto">
                <div className="flex justify-between items-center mb-4">
                  <h1 className="text-5xl font-bold text-white drop-shadow-lg">
                    üîç Charlie & Isla - Odd One Out üîç
                  </h1>
                  <div className="text-2xl font-bold text-white bg-white bg-opacity-20 backdrop-blur-sm px-6 py-3 rounded-full">
                    üë§ {currentUser?.name}
                  </div>
                </div>
                <p className="text-xl text-white text-center mb-6">Find the different emoji as fast as you can!</p>
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                  <div className="lg:col-span-2">
                    <div className="bg-white rounded-2xl p-6 shadow-2xl">
                      <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2 text-2xl font-bold text-purple-600">
                          <ClockIcon />
                          {formatTime(currentTime)}
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={prepareGame}
                            className="flex items-center gap-2 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-2 px-4 rounded-full hover:scale-105 transition-transform"
                          >
                            <RotateCcwIcon />
                            New Game
                          </button>
                          <button
                            onClick={handleLogout}
                            className="flex items-center gap-2 bg-red-500 text-white font-bold py-2 px-4 rounded-full hover:scale-105 transition-transform"
                          >
                            <LogOutIcon />
                            Logout
                          </button>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-10 gap-0.5 bg-gray-100 p-2 rounded-xl">
                        {grid.map((emoji, index) => (
                          <button
                            key={index}
                            onClick={() => handleClick(index)}
                            className="aspect-square text-2xl hover:bg-yellow-200 rounded transition-colors flex items-center justify-center"
                          >
                            {emoji}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl p-6 shadow-2xl">
                    <h2 className="text-2xl font-bold text-purple-600 mb-4 flex items-center gap-2">
                      <TrophyIcon />
                      Leaderboard
                    </h2>
                    <p className="text-xs text-gray-500 mb-3">(Best time per player - Live Global)</p>
                    {leaderboard.length === 0 ? (
                      <p className="text-gray-500 text-center py-8">No scores yet. Be the first!</p>
                    ) : (
                      <div className="space-y-2">
                        {leaderboard.map((entry, index) => (
                          <div
                            key={index}
                            className={`flex justify-between items-center p-3 rounded-lg ${
                              index === 0 ? 'bg-yellow-100' : index === 1 ? 'bg-gray-100' : index === 2 ? 'bg-orange-100' : 'bg-gray-50'
                            } ${entry.name === currentUser?.name ? 'ring-2 ring-purple-500' : ''}`}
                          >
                            <div className="flex items-center gap-3">
                              <span className="text-xl font-bold text-gray-600 w-6">
                                {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`}
                              </span>
                              <span className="font-semibold text-gray-800">{entry.name}</span>
                            </div>
                            <span className="font-mono font-bold text-purple-600">
                              {formatTime(entry.time)}
                            </span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-4 text-white text-center">
                  <p className="text-sm">üí° Tip: The different emoji is very similar but not identical. Look carefully!</p>
                  <p className="text-xs mt-1 opacity-75">Logged in as: {currentUser?.name}</p>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<OddOneOutGame />, document.getElementById('root'));
    </script>
</body>
</html>
